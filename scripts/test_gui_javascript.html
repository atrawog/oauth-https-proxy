<!DOCTYPE html>
<html>
<head>
    <title>Test GUI JavaScript</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Testing GUI JavaScript Functions</h1>
    
    <div class="section">
        <h2>1. Testing API Client</h2>
        <button onclick="testAPI()">Test API</button>
        <pre id="api-output"></pre>
    </div>

    <div class="section">
        <h2>2. Testing loadCertificates Function</h2>
        <button onclick="testLoadCertificates()">Test loadCertificates</button>
        <div id="certificates-list">
            <div class="loading">Click button to load...</div>
        </div>
    </div>

    <div class="section">
        <h2>3. Console Output</h2>
        <pre id="console-output"></pre>
    </div>

    <script>
    // Override console.log to also display in page
    const consoleOutput = document.getElementById('console-output');
    const originalLog = console.log;
    console.log = function(...args) {
        originalLog.apply(console, args);
        consoleOutput.textContent += args.join(' ') + '\n';
    };

    // Copy the exact API client from app.js
    class CertificateAPI {
        constructor() {
            this.baseURL = '';
            this.token = 'acm_PikI3FoqDXghOEHdP9lf9wcf0zlEdK2AV9DvPinF-Us'; // ADMIN token
        }

        async request(method, endpoint, data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (this.token) {
                options.headers['Authorization'] = `Bearer ${this.token}`;
            }

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(`${this.baseURL}${endpoint}`, options);
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Request failed');
            }

            return response.json();
        }

        async getCertificates() {
            return this.request('GET', '/certificates');
        }
    }

    const api = new CertificateAPI();
    let certificates = [];
    let currentTokenInfo = { name: 'ADMIN' }; // Simulate logged in as ADMIN

    async function testAPI() {
        const output = document.getElementById('api-output');
        try {
            output.textContent = 'Testing API calls...\n';
            
            // Test certificates
            const certs = await api.getCertificates();
            output.textContent += `\nCertificates: ${certs.length} found\n`;
            output.textContent += JSON.stringify(certs, null, 2);
            
        } catch (error) {
            output.textContent += `\nERROR: ${error.message}\n`;
            output.textContent += error.stack;
        }
    }

    // Copy exact loadCertificates function from app.js
    async function loadCertificates() {
        console.log('loadCertificates called');
        const listContainer = document.getElementById('certificates-list');
        listContainer.innerHTML = '<div class="loading">Loading certificates...</div>';

        try {
            certificates = await api.getCertificates();
            console.log('Certificates received:', certificates);
            
            if (certificates.length === 0) {
                console.log('No certificates found');
                // Check if this is a non-admin user
                const isNonAdmin = currentTokenInfo && currentTokenInfo.name !== 'ADMIN';
                if (isNonAdmin) {
                    listContainer.innerHTML = '<div class="empty-state">No certificates owned by your token. Non-admin users can only see their own certificates.</div>';
                } else {
                    listContainer.innerHTML = '<div class="empty-state">No certificates found. Create your first certificate!</div>';
                }
                return;
            }

            console.log('Updating innerHTML with certificates');
            listContainer.innerHTML = certificates.map(cert => {
                // Check if certificate is using staging
                const isStaging = cert.acme_directory_url && cert.acme_directory_url.includes('staging');
                
                return `
                <div class="certificate-card" data-cert-name="${cert.cert_name}">
                    <div class="cert-header">
                        <h3>${cert.cert_name}</h3>
                        <span class="cert-status status-${cert.status}">${cert.status}</span>
                        ${isStaging ? '<span class="cert-staging">STAGING</span>' : ''}
                    </div>
                    <div class="cert-info">
                        <p><strong>Domains:</strong> ${cert.domains.join(', ')}</p>
                        <p><strong>Expires:</strong> ${formatDate(cert.expires_at)}</p>
                        ${isStaging ? '<p class="staging-warning">⚠️ This is a staging certificate (not trusted by browsers)</p>' : ''}
                    </div>
                </div>
                `;
            }).join('');
            console.log('innerHTML updated');

        } catch (error) {
            console.log('Error in loadCertificates:', error);
            listContainer.innerHTML = `<div class="error">Error loading certificates: ${error.message}</div>`;
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'Unknown';
        const date = new Date(dateString);
        const now = new Date();
        const daysUntil = Math.floor((date - now) / (1000 * 60 * 60 * 24));
        
        const formatted = date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'UTC'
        }) + ' UTC';
        
        return `${formatted} (${daysUntil} days)`;
    }

    async function testLoadCertificates() {
        console.log('=== Testing loadCertificates ===');
        await loadCertificates();
        console.log('=== Test complete ===');
    }
    </script>
</body>
</html>