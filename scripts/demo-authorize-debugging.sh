#!/bin/bash
# Demonstration of enhanced OAuth /authorize debugging

echo "=== Enhanced OAuth /authorize Debugging Examples ==="
echo ""
echo "The enhanced logging now shows detailed validation results and rejection reasons:"
echo ""
echo "1. ✅ SUCCESSFUL AUTHORIZATION (all validations pass):"
echo "   2025-08-02 17:00:00Z [INFO] auth.atradev.org 213.47.196.26 - GET /authorize [OAuth:authorize] q=client_id=client_Ebb8g95l9shqpxykc0pmBg redirect_uri=https%3A%2F%2Fclaude.ai%2Fapi%2Fmcp%2Fauth_call state=abc123 scope=mcp%3Aread+mcp%3Awrite UA=\"Mozilla/5.0\""
echo "   2025-08-02 17:00:00Z [INFO] auth.atradev.org 213.47.196.26 -> 307 (8ms) redirect_to=https://github.com/login/oauth/authorize auth=pending_github_auth validations=all decision=pending_user_consent"
echo ""
echo "2. ❌ REJECTED - Invalid Client:"
echo "   2025-08-02 17:01:00Z [INFO] auth.atradev.org 213.47.196.26 - GET /authorize [OAuth:authorize] q=client_id=invalid_client_123 redirect_uri=https%3A%2F%2Fexample.com%2Fcallback UA=\"Mozilla/5.0\""
echo "   2025-08-02 17:01:00Z [WARNING] auth.atradev.org 213.47.196.26 -> 400 (2ms) auth=rejected rejection=invalid_client"
echo ""
echo "3. ❌ REJECTED - Invalid Redirect URI:"
echo "   2025-08-02 17:02:00Z [INFO] auth.atradev.org 213.47.196.26 - GET /authorize [OAuth:authorize] q=client_id=client_Ebb8g95l9shqpxykc0pmBg redirect_uri=https%3A%2F%2Fevil.com%2Fcallback UA=\"Mozilla/5.0\""
echo "   2025-08-02 17:02:00Z [WARNING] auth.atradev.org 213.47.196.26 -> 400 (3ms) auth=rejected rejection=invalid_redirect_uri"
echo ""
echo "4. ❌ REJECTED - Unsupported Response Type:"
echo "   2025-08-02 17:03:00Z [INFO] auth.atradev.org 213.47.196.26 - GET /authorize [OAuth:authorize] q=client_id=client_Ebb8g95l9shqpxykc0pmBg response_type=token UA=\"Mozilla/5.0\""
echo "   2025-08-02 17:03:00Z [WARNING] auth.atradev.org 213.47.196.26 -> 307 (3ms) redirect_to=https://claude.ai/api/mcp/auth_callback?error=unsupported_response_type auth=rejected rejection=unsupported_response_type"
echo ""
echo "5. ❌ REJECTED - Invalid PKCE Method:"
echo "   2025-08-02 17:04:00Z [INFO] auth.atradev.org 213.47.196.26 - GET /authorize [OAuth:authorize] q=client_id=client_Ebb8g95l9shqpxykc0pmBg code_challenge_method=plain UA=\"Mozilla/5.0\""
echo "   2025-08-02 17:04:00Z [WARNING] auth.atradev.org 213.47.196.26 -> 400 (2ms) auth=rejected rejection=invalid_pkce_method"
echo ""
echo "6. ❌ REJECTED - Invalid Resource URI:"
echo "   2025-08-02 17:05:00Z [INFO] auth.atradev.org 213.47.196.26 - GET /authorize [OAuth:authorize] q=client_id=client_Ebb8g95l9shqpxykc0pmBg resource=not-a-uri UA=\"Mozilla/5.0\""
echo "   2025-08-02 17:05:00Z [WARNING] auth.atradev.org 213.47.196.26 -> 307 (3ms) redirect_to=https://claude.ai/api/mcp/auth_callback?error=invalid_resource auth=rejected rejection=invalid_resource_uri"
echo ""
echo "=== Key Debugging Information ==="
echo ""
echo "Response lines now show:"
echo "- auth: Authorization status (pending_github_auth, rejected)"
echo "- rejection: Specific reason for rejection"
echo "- validations: Whether all validations passed"
echo "- decision: Authorization decision (pending_user_consent, rejected)"
echo ""
echo "Console logs will also show detailed validation information:"
echo "- Client validation results with registered redirect URIs"
echo "- Specific validation failures with expected vs actual values"
echo "- Resource validation details"
echo ""
echo "This provides complete visibility into why an authorization request succeeded or failed!"